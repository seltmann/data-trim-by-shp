---
title: "filter_polygon"
author: "JT_Miller"
date: "6/22/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# started by Katja Seltmann, 2020
# Script to map occurrence records of species (lat/long) that occur only within the boundaries of Coal Oil Point Reserve (shp file)
# COPR occurrence records in tab-delimited format: https://ucsb.box.com/s/7xp88xhg1xn7decsv0t3ll8du653deub
# COPR boundary files: https://ucsb.box.com/s/nd1s0e3ted8zsu0ir4wbxu7qpe94ht8o

#The goal of this script is to:
#draw boundary of copr on map
#Trim specimen_data (occurrence.txt) based on copr boundary creating new file that only contains specimens whose coordinates are within that boundary

```{r}
#required libraries
library(ggplot2)
library(maptools)
library(sf)
library(maps)
library(raster)
library(rgdal)
library(dplyr)
```


```{r}
#file that contains over 75K of specimen data with lat/long coordinates
specimen_data <- read.delim(file="occurrence.txt",header=TRUE)
```


```{r}
#print data dimensions
dim(specimen_data)

names(specimen_data)

```

```{r}
#remove rows where lat/long do not exist
specimen_data <- subset(specimen_data, !is.na(order) & !is.na(decimalLongitude) & !is.na(decimalLatitude))


```


```{r}
#print data dimensions
dim(specimen_data)


```


```{r}
#remove columns and rows for smaller test dataset that only includes long and lat, and limit to only 100 rows for testing

#column decimalLongitude = 134
#column decimalLatitude = 133

specimen_data_less <-specimen_data[1:100,c(134,133)]
head(specimen_data_less)


specimen_data_proj <- specimen_data[1:1000, c(137)]

specimen_data_proj

specimen_crs <- specimen_data %>% 
  dplyr::select(decimalLatitude, decimalLongitude, verbatimCoordinateSystem )
```


```{r}
#print dimensions of new dataset
dim(specimen_data_less)

```

```{r}
#read boundary from shp file
copr_boundary_2020 <- st_read("COPR_Boundary_2010/COPR_boundary2010.shp") #Vector type. 

copr_boundary_2020
#What is the projection of copr_boundary_2020

#Global datum is NAD83. California zone 5 is code: ESPG:2229. 

st_geometry_type(copr_boundary_2020) #18 levels, MultiPolygon

st_crs(copr_boundary_2020) #Projection is lcc...not sure what this is: https://en.wikipedia.org/wiki/Lambert_conformal_conic_projection 

#so this is in lat long, but not decimal formatting (degrees)

extent(copr_boundary_2020) 

st_bbox(copr_boundary_2020) #Same thing as above just easier formatting on the boundary edges. 

head(copr_boundary_2020)
#Seems there is only one feature, therefore we can't split it up in any meaningful way to look at individual parts. 

copr_boundary_2020
```



```{r}
#draw boundary from shp file
ggplot() +
  geom_sf(data = copr_boundary_2020, fill = "palegreen", color = "black")


```
```{r}

#First lets change the txt. data into a sf object that uses the standard crs = 4326 for latlong. 

occur_sf_orig <- st_as_sf(specimen_data_less, coords = c('decimalLongitude', 'decimalLatitude'), crs = 4326)

#Now lets transform this new sf object to the crs using our boundary data 

occur_sf_new <- st_transform(occur_sf_orig, 
                             st_crs(copr_boundary_2020))
#Check the extents, they appear to be in the same range 
extent(occur_sf_new)

extent(copr_boundary_2020)
```

```{r}

#Plotting shows that the data points do appear in the right location now! We are not getting a display of the map however, lets see if we can troubleshoot this. 
ggplot() +
  geom_sf(data = copr_boundary_2020, fill = "palegreen", color = "black") +
  geom_sf(occur_sf_new, mapping = aes(geometry = geometry)) 
```

















































  






  




  



